<html>
  <head>
    <meta charset="UTF-8" />

    <title>Homework 3</title>

    <style>
        body{
            font-family: 'Lato', 'Helvetica', sans-serif;
            margin: 20px;
            font-family: "Avenir", sans-serif;
        }

        h1 {
            display: flex;
            font-family: "Sinhala MN";
            text-align: center;
            align-self: center;
            align-content: center;
        }

        h1.title{
            font-family: "Avenir", sans-serif;
            position: relative;
            font-size: 50px;
            font-weight: bold;
        }


        h2 {
            font-family: "Sinhala MN";
            font-weight: lighter;
        }

       
    </style>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/jeezy@1.13.1/lib/jeezy.js"></script>
    <script src="https://unpkg.com/jeezy@1.13.1/lib/jeezy.min.js"></script>
    <script src="neighborhoods.js"></script>

  </head>
  <body>
    <h1>Homework 3</h1>
    <h2>Sydney Bednar (sb844), Victoria Eshun (vee4), Noorejehan Umar (nu44)</h2>


    <div class="title">
    <h1>[Title Here]</h1>
    
    <p> [Intro Here]
    </p>
    </div>
    <svg id="map", width = "1200", height = "500"></svg>
    <script>
      const svg = d3.select("svg#map")
      const margins = { top: 10, right: 50, bottom: 40, left: 50 };
      const mapWidth = svg.attr("width")/2
      const mapHeight = svg.attr("height")

      const requestData = async () => {
        let restaurants = await d3.csv('boston_yelp.csv', d3.autoType)
        
        console.log(restaurants)

        let bostonRes = restaurants.filter(d => d.city === "Boston")

        // const ma = await d3.json("ma.json");

        // console.log(ma)

        // const towns = await d3.json("cities.json");

        // console.log(towns)

        console.log(neighborhoods_json)

        var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], neighborhoods_json)

        var path = d3.geoPath().projection(projection);
       

//       var neighborhoods = topojson.feature(ma, ma.objects.cb_2015_massachusetts_county_20m);


//       var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], neighborhoods)

//       var path = d3.geoPath().projection(projection);

        var map = svg.append("g").attr("class", "map");

        let neighborhoods = map.selectAll("path")
            .data(neighborhoods_json.features)
            .enter()
            .append("path")
            .attr("id", d => d.properties.name)
            .attr("class", "neighborhood")
            .style("fill", "white")
            .attr( "stroke", "#999")
            .attr("d", path);


        //Adding the names to the neighborhoods

        // map.selectAll(".neighborhood-label")
        //     .data(neighborhoods_json.features)
        //     .enter()
        //     .append("text")
        //     .attr("class", "neighborhood-label")
        //     .attr("transform", function(d) {
        //         return "translate(" + path.centroid(d) + ")";
        //     })
        //     .attr("dy", "0em")
        //     .attr("dx", "-2em")
        //     .attr("font-size", 4)
        //     .text(function(d) { return d.properties.Name; });

        
        // label neighborhoods

        bostonRes.forEach( d => {
      
          d.Position = projection( [d.longitude, d.latitude] );
          
        });

        console.log(restaurants[0])
        console.log(neighborhoods)


        neighborhoods.append("text")
        .attr("class", "neighborhood-label")
        .attr("transform", function(d) {
          return "translate(" + path.centroid(d) + ")";
        })
        .attr("dy", ".35em")
        .text(function(d) { return d.properties.Name; });

        let circles = map.selectAll("circle").data(bostonRes)
          .join("circle")
          .attr("id", d => d.name)
          .attr("r", 1.5)
          .attr("fill", "forestgreen")
          .attr("opacity", 0.5)
          .attr("cx", d => d.Position[0])
          .attr("cy", d => d.Position[1]);
        
        // need to edit translate extent now that map is only half of svg
        var zoom = d3.zoom()
                  .scaleExtent([1,100])
                  // .translateExtent([[-50,-50],[mapWidth+50,mapHeight+50]])  // to lock to edges
                  .on("zoom", neighborhoodZoom);

        map.call(zoom);

        map.call(zoom.transform, d3.zoomIdentity);

        function neighborhoodZoom({transform}) {       

          map.attr("transform", transform.toString() );

        }

        map.selectAll(".neighborhood").on("click", selected);

//Neighborhood names show up on hover on bottom left
      // var tooltip = d3.select("body")
      //   .append("div")
      //   .attr("class", "tooltip")
      //   .style("opacity", 0);

      // d3.selectAll(".neighborhood")
      //   .on("mouseover", function(event, d) {
      //     tooltip.transition()
      //       .duration(200)
      //       .style("opacity", 0.9);
      //     tooltip.html(d.properties.Name)
      //       .style("left", (event.pageX + 10) + "px")
      //       .style("top", (event.pageY - 30) + "px");
      //   })
      //   .on("mouseout", function(d) {
      //     tooltip.transition()
      //       .duration(500)
      //       .style("opacity", 0);
      //   });


      

        function selected(event, d) {
          //NOTE: this is Jeff's code, will change to original code, just wanted to test click and zoom
          console.log(d)

          let bounds = path.bounds(d.geometry); 
          let dx = bounds[1][0] - bounds[0][0]; 
          let dy = bounds[1][1] - bounds[0][1]; 
          let x = (bounds[0][0] + bounds[1][0]) / 2; 
          let y = (bounds[0][1] + bounds[1][1]) / 2; 

          
          let scale = Math.max(1, Math.min(10, 0.9 / Math.max( dx / mapWidth, 
                                                              dy / mapHeight )));

          let translate = [mapWidth / 2 - x * scale, mapHeight / 2 - y * scale];

          let newTransform = d3.zoomIdentity
                                .translate(translate[0],translate[1])
                                .scale(scale);
         
          map.transition().duration(1000).call(zoom.transform, newTransform);

          

        }

        // quiz panel
        var quiz = svg.append("g").attr("class", "quiz").attr("transform", `translate(${mapWidth}, 0)`)
        var quizWidth = svg.attr("width") - mapWidth


        // step one
        let stepOne = quiz.append("g")

        // add rect to see border -- can remove later
        stepOne.append("rect")
               .attr("width", quizWidth)
               .attr("height", mapHeight)
               .style("fill", "none")
               .style("stroke", "black")
               .style("stroke-width", 1)

        stepOne.append("text")
          .text("Welcome to Boston!")
          .attr("x", quizWidth / 2)
          .attr("y", 30)
          .attr("text-anchor", "middle")
          .style("font-size", 24)


        



      }
      requestData();

    </script>
   
  </body>
</html>